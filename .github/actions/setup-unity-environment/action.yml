name: 'Setup Unity Environment'
description: 'Sets up .NET, NuGetForUnity, and Unity Library cache'

inputs:
  version:
    description: 'Version string to use (optional, auto-generated if not provided)'
    required: false
    type: string
  unity-project-path:
    description: 'Path to Unity project'
    required: false
    default: 'unity'
  cache-key-suffix:
    description: 'Additional suffix for cache key'
    required: false
    default: 'Android-Windows'
  dotnet-version:
    description: '.NET version to install'
    required: false
    default: '8.x'

outputs:
  cache-hit:
    description: 'Whether the Unity Library cache was hit'
    value: ${{ steps.cache-unity.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Determine Version
      id: version-info
      uses: ./.github/actions/determine-version
      with:
        version: ${{ inputs.version }}

    - name: Install NuGetForUnity CLI
      shell: pwsh
      run: dotnet tool install --global NuGetForUnity.Cli

    - name: Install DocFX
      shell: pwsh
      run: dotnet tool install --global docfx

    - name: Restore NuGet Packages
      shell: pwsh
      run: nugetforunity restore ${{ inputs.unity-project-path }}/

    - name: Restore Generated Protobufs
      uses: actions/download-artifact@v5
      with:
        name: questnav-proto-csharp-${{ steps.version-info.outputs.version }}
        path: ${{ inputs.unity-project-path }}/Assets/QuestNav/Generated

    - name: Restore Generated Web UI
      uses: actions/download-artifact@v5
      with:
        name: questnav-web-ui-${{ steps.version-info.outputs.version }}
        path: ${{ inputs.unity-project-path }}/Assets/StreamingAssets/ui

    - name: Cache Unity Library
      id: cache-unity
      uses: actions/cache@v4
      with:
        path: ${{ inputs.unity-project-path }}/Library
        key: Library-QuestNav-${{ inputs.cache-key-suffix }}-${{ hashFiles(format('{0}/Packages/manifest.json', inputs.unity-project-path)) }}
        restore-keys: |
          Library-QuestNav-${{ inputs.cache-key-suffix }}-
          Library-QuestNav-
          Library-